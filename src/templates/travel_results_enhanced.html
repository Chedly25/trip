<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Perfect European Road Trip</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/logo.svg">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="/static/logo.svg">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="/static/logo.svg">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="this.onerror=null; document.head.appendChild(document.createElement('link')).href='/static/fallback.css';">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Fallback CSS for icons and fonts -->
    <link rel="stylesheet" href="/static/fallback.css">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #06b6d4;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--gradient);
            min-height: 100vh;
            color: var(--gray-800);
            overflow-x: hidden;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="90" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="10" cy="60" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            animation: float 20s linear infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            100% { transform: translateY(-100px) rotate(360deg); }
        }
        
        .hero-header {
            background: transparent;
            color: white;
            padding: 3rem 0 2rem;
            text-align: center;
            position: relative;
        }
        
        .hero-title {
            font-family: 'Playfair Display', Georgia, 'Times New Roman', serif;
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            letter-spacing: -0.02em;
        }
        
        .hero-subtitle {
            font-size: clamp(1rem, 2vw, 1.2rem);
            opacity: 0.95;
            font-weight: 400;
            line-height: 1.6;
        }
        
        .itinerary-card {
            background: var(--glass-bg);
            border-radius: 32px;
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            box-shadow: 
                0 32px 64px rgba(0,0,0,0.1),
                0 0 0 1px rgba(255,255,255,0.2);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }
        
        .itinerary-card:hover {
            transform: translateY(-8px);
            box-shadow: 
                0 40px 80px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.3);
            background: rgba(255, 255, 255, 0.8);
        }
        
        .itinerary-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .itinerary-icon {
            width: 72px;
            height: 72px;
            border-radius: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.75rem;
            margin-right: 1.5rem;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        
        .itinerary-card:hover .itinerary-icon {
            transform: scale(1.05) rotate(5deg);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.4);
        }
        
        .itinerary-title {
            font-family: 'Playfair Display', Georgia, 'Times New Roman', serif;
            font-size: 1.9rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .itinerary-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
            line-height: 1.5;
            font-weight: 400;
        }
        
        .route-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.5);
            padding: 1rem 1.25rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }
        
        .stat-item:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-2px);
        }
        
        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .stat-text {
            color: var(--gray-800);
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .route-map {
            height: 350px;
            border-radius: 20px;
            margin-bottom: 2rem;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .cities-list {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .city-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transition: all 0.2s ease;
        }
        
        .city-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }
        
        .highlights-section {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .highlights-title {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
        }
        
        .highlight-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 1rem 1.25rem;
            border-radius: 14px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-700);
            transition: all 0.2s ease;
        }
        
        .highlight-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(4px);
        }
        
        .cost-estimate {
            background: rgba(240, 249, 255, 0.8);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid rgba(186, 230, 253, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .cost-title {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
        }
        
        .cost-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1.25rem;
        }
        
        .cost-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            padding: 1.5rem 1rem;
            border-radius: 16px;
            border: 1px solid rgba(224, 242, 254, 0.8);
            transition: all 0.2s ease;
        }
        
        .cost-item:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .cost-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }
        
        .cost-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .select-route-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            color: white;
            padding: 1.25rem 2.5rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
            width: 100%;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .select-route-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .select-route-btn:hover::before {
            left: 100%;
        }
        
        .select-route-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.3);
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
        }
        
        .route-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .route-action-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }
        
        .action-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }
        
        .save-btn.saved {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .share-btn {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.3);
        }
        
        .weather-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .weather-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: var(--gray-800);
            padding: 1rem 1.75rem;
            border-radius: 20px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
            margin-bottom: 2.5rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .back-btn:hover {
            background: white;
            color: var(--primary);
            text-decoration: none;
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
        }
        
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }
            
            .itinerary-card {
                padding: 1.5rem;
            }
            
            .route-stats {
                gap: 1rem;
            }
            
            .cities-list {
                gap: 0.5rem;
            }
            
            .city-badge {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }
        
        .leaflet-container {
            border-radius: 12px;
        }
        
        .route-type-scenic { --route-color: #10b981; }
        .route-type-cultural { --route-color: #8b5cf6; }
        .route-type-adventure { --route-color: #f59e0b; }
        .route-type-culinary { --route-color: #ef4444; }
        .route-type-romantic { --route-color: #ec4899; }
        .route-type-hidden_gems { --route-color: #6366f1; }
        
        .itinerary-card[data-route-type="scenic"] .itinerary-icon,
        .itinerary-card[data-route-type="scenic"] .stat-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .itinerary-card[data-route-type="cultural"] .itinerary-icon,
        .itinerary-card[data-route-type="cultural"] .stat-icon {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .itinerary-card[data-route-type="adventure"] .itinerary-icon,
        .itinerary-card[data-route-type="adventure"] .stat-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .itinerary-card[data-route-type="culinary"] .itinerary-icon,
        .itinerary-card[data-route-type="culinary"] .stat-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .itinerary-card[data-route-type="romantic"] .itinerary-icon,
        .itinerary-card[data-route-type="romantic"] .stat-icon {
            background: linear-gradient(135deg, #ec4899, #db2777);
        }
        
        .itinerary-card[data-route-type="hidden_gems"] .itinerary-icon,
        .itinerary-card[data-route-type="hidden_gems"] .stat-icon {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
        }
    </style>
</head>
<body>
    <div class="hero-header">
        <div class="container">
            <h1 class="hero-title">
                <i class="fas fa-route me-2"></i>
                Your Perfect European Road Trip
            </h1>
            <p class="hero-subtitle">
                <span id="route-summary">5 amazing itineraries crafted just for you</span>
            </p>
        </div>
    </div>

    <div class="container mt-4">
        <a href="/" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Plan Another Trip
        </a>

        <div id="itineraries-container">
            <!-- Itineraries will be loaded here by JavaScript -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Route type configurations
        const routeTypeConfig = {
            'scenic': {
                icon: 'fa-mountain',
                color: '#10b981',
                mapColor: '#10b981'
            },
            'cultural': {
                icon: 'fa-monument',
                color: '#8b5cf6',
                mapColor: '#8b5cf6'
            },
            'adventure': {
                icon: 'fa-hiking',
                color: '#f59e0b',
                mapColor: '#f59e0b'
            },
            'culinary': {
                icon: 'fa-utensils',
                color: '#ef4444',
                mapColor: '#ef4444'
            },
            'romantic': {
                icon: 'fa-heart',
                color: '#ec4899',
                mapColor: '#ec4899'
            },
            'hidden_gems': {
                icon: 'fa-gem',
                color: '#6366f1',
                mapColor: '#6366f1'
            }
        };


        // Utility function to format numbers to 2 decimal places
        function formatNumber(num) {
            if (typeof num === 'number') {
                return Number(num.toFixed(2));
            }
            return num;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadItineraries();
        });

        function loadItineraries() {
            const container = document.getElementById('itineraries-container');
            const routeSummary = document.getElementById('route-summary');
            
            // Try to get data from sessionStorage (from form submission)
            let itineraries = [];
            try {
                const storedData = sessionStorage.getItem('travelPlanResult');
                console.log('Stored data:', storedData);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    console.log('Parsed data:', data);
                    itineraries = data.data?.routes || [];
                    console.log('Extracted routes:', itineraries);
                }
            } catch (e) {
                console.error('Error loading stored data:', e);
            }
            
            // Show message if no real data available (no fake data)
            if (itineraries.length === 0) {
                console.log('No real data found');
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: white;">
                        <h3>No Trip Results Available</h3>
                        <p>Please go back and plan a new trip to see results here.</p>
                        <a href="/" style="display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem; padding: 1rem 2rem; background: var(--primary); color: white; text-decoration: none; border-radius: 12px;">
                            <i class="fas fa-arrow-left"></i>
                            Plan New Trip
                        </a>
                    </div>
                `;
                return;
            } else {
                console.log('Using real data from API');
            }
            
            // Update summary
            routeSummary.textContent = `${itineraries.length} amazing itineraries crafted just for you`;
            
            // Render each itinerary
            container.innerHTML = '';
            itineraries.forEach((itinerary, index) => {
                const itineraryHtml = createItineraryCard(itinerary, index);
                container.insertAdjacentHTML('beforeend', itineraryHtml);
                
                // Initialize map for this itinerary
                setTimeout(() => initializeMap(itinerary, index), 100);
            });
        }

        function createItineraryCard(itinerary, index) {
            const config = routeTypeConfig[itinerary.route_type] || routeTypeConfig['scenic'];
            
            // Handle both API format and sample format
            const intermediateCities = itinerary.intermediate_cities || [];
            const citiesBadges = intermediateCities
                .map(city => {
                    const cityName = typeof city === 'string' ? city : (city.name || 'Unknown City');
                    return `<div class="city-badge">
                        <i class="fas fa-map-marker-alt"></i>
                        ${cityName}
                    </div>`;
                })
                .join('');
            
            // Handle highlights safely
            const highlights = itinerary.highlights || [];
            const highlightItems = highlights
                .map(highlight => `<div class="highlight-item">${highlight}</div>`)
                .join('');
            
            return `
                <div class="itinerary-card" data-route-type="${itinerary.route_type}">
                    <div class="itinerary-header">
                        <div class="itinerary-icon">
                            <i class="fas ${config.icon}"></i>
                        </div>
                        <div>
                            <h3 class="itinerary-title">${itinerary.name}</h3>
                            <p class="itinerary-subtitle">${itinerary.description}</p>
                        </div>
                    </div>
                    
                    <div class="route-stats">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-route"></i>
                            </div>
                            <div class="stat-text">${formatNumber(itinerary.total_distance_km)} km</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-text">${formatNumber(itinerary.total_duration_hours)}h driving</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="stat-text">${(itinerary.intermediate_cities || []).length + 2} stops</div>
                        </div>
                    </div>
                    
                    <div class="route-map" id="map-${index}"></div>
                    
                    <div class="cities-list">
                        <div class="city-badge">
                            <i class="fas fa-play"></i>
                            ${itinerary.start_city.name}
                        </div>
                        ${citiesBadges}
                        <div class="city-badge">
                            <i class="fas fa-flag-checkered"></i>
                            ${itinerary.end_city.name}
                        </div>
                    </div>
                    
                    <div class="highlights-section">
                        <h5 class="highlights-title">
                            <i class="fas fa-star"></i>
                            Route Highlights
                        </h5>
                        ${highlightItems}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-users me-1"></i>
                                Ideal for: ${itinerary.ideal_for}
                            </small>
                        </div>
                    </div>
                    
                    <div class="cost-estimate">
                        <h5 class="cost-title">
                            <i class="fas fa-euro-sign"></i>
                            Estimated Costs
                        </h5>
                        <div class="cost-breakdown">
                            <div class="cost-item">
                                <div class="cost-amount">€${formatNumber(itinerary.estimated_cost.fuel_estimate)}</div>
                                <div class="cost-label">Fuel</div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-amount">€${formatNumber(itinerary.estimated_cost.accommodation_estimate)}</div>
                                <div class="cost-label">Accommodation</div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-amount">€${formatNumber(itinerary.estimated_cost.total_estimate)}</div>
                                <div class="cost-label">Total Estimate</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="route-actions">
                        <button class="select-route-btn" onclick="selectRoute(${index})">
                            <i class="fas fa-check-circle me-2"></i>
                            Select This Route
                        </button>
                        <div class="route-action-buttons">
                            <button class="action-btn save-btn" onclick="saveTrip(${index})" title="Save Trip">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="action-btn share-btn" onclick="shareTrip(${index})" title="Share Trip">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="action-btn weather-btn" onclick="checkWeather(${index})" title="Check Weather">
                                <i class="fas fa-cloud-sun"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeMap(itinerary, index) {
            const mapId = `map-${index}`;
            const mapElement = document.getElementById(mapId);
            
            if (!mapElement) return;
            
            // Create map
            const map = L.map(mapId).setView([45.0, 7.0], 6);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Create route coordinates - handle different data formats
            const startCoords = Array.isArray(itinerary.start_city.coordinates) 
                ? itinerary.start_city.coordinates 
                : [itinerary.start_city.coordinates.latitude, itinerary.start_city.coordinates.longitude];
            
            const endCoords = Array.isArray(itinerary.end_city.coordinates)
                ? itinerary.end_city.coordinates
                : [itinerary.end_city.coordinates.latitude, itinerary.end_city.coordinates.longitude];
            
            const intermediateCoords = (itinerary.intermediate_cities || []).map(city => {
                if (typeof city === 'string') return null; // Skip string cities
                if (Array.isArray(city.coordinates)) return city.coordinates;
                if (city.coordinates && city.coordinates.latitude) {
                    return [city.coordinates.latitude, city.coordinates.longitude];
                }
                return null;
            }).filter(coord => coord !== null);
            
            const routeCoords = [startCoords, ...intermediateCoords, endCoords];
            
            // Add route line
            const config = routeTypeConfig[itinerary.route_type] || routeTypeConfig['scenic'];
            const routeLine = L.polyline(routeCoords, {
                color: config.mapColor,
                weight: 4,
                opacity: 0.8
            }).addTo(map);
            
            // Add markers
            const startIcon = L.divIcon({
                html: '<i class="fas fa-play" style="color: #10b981;"></i>',
                iconSize: [20, 20],
                className: 'custom-div-icon'
            });
            
            const endIcon = L.divIcon({
                html: '<i class="fas fa-flag-checkered" style="color: #ef4444;"></i>',
                iconSize: [20, 20],
                className: 'custom-div-icon'
            });
            
            const wayIcon = L.divIcon({
                html: '<i class="fas fa-map-marker-alt" style="color: ' + config.mapColor + ';"></i>',
                iconSize: [20, 20],
                className: 'custom-div-icon'
            });
            
            // Add start marker
            L.marker(startCoords, {icon: startIcon})
                .addTo(map)
                .bindPopup(`<b>Start:</b> ${itinerary.start_city.name}`);
            
            // Add intermediate markers
            (itinerary.intermediate_cities || []).forEach(city => {
                if (typeof city === 'string') return; // Skip string cities
                
                let cityCoords;
                if (Array.isArray(city.coordinates)) {
                    cityCoords = city.coordinates;
                } else if (city.coordinates && city.coordinates.latitude) {
                    cityCoords = [city.coordinates.latitude, city.coordinates.longitude];
                } else {
                    return; // Skip if no valid coordinates
                }
                
                const cityTypes = city.types ? city.types.join(', ') : 'Intermediate stop';
                L.marker(cityCoords, {icon: wayIcon})
                    .addTo(map)
                    .bindPopup(`<b>${city.name}</b><br/>${cityTypes}`);
            });
            
            // Add end marker
            L.marker(endCoords, {icon: endIcon})
                .addTo(map)
                .bindPopup(`<b>Destination:</b> ${itinerary.end_city.name}`);
            
            // Fit map to route
            map.fitBounds(routeLine.getBounds(), {padding: [20, 20]});
        }

        function selectRoute(index) {
            // Get the selected route data
            let itineraries = [];
            try {
                const storedData = sessionStorage.getItem('travelPlanResult');
                if (storedData) {
                    const data = JSON.parse(storedData);
                    itineraries = data.data?.routes || [];
                }
            } catch (e) {
                console.error('Error loading stored data:', e);
            }
            
            // If no real data available, show message instead of fake data
            if (itineraries.length === 0) {
                document.getElementById('routeContainer').innerHTML = `
                    <div class="no-results-message">
                        <h3>No Trip Results Available</h3>
                        <p>Please go back and plan a new trip to see results here.</p>
                        <a href="/" class="back-btn">
                            <i class="fas fa-arrow-left"></i>
                            Plan New Trip
                        </a>
                    </div>
                `;
                return;
            }
            
            if (itineraries[index]) {
                // Store the selected route in sessionStorage
                const selectedRoute = itineraries[index];
                sessionStorage.setItem('selectedRoute', JSON.stringify(selectedRoute));
                
                // Navigate to trip details page
                window.location.href = '/trip-details';
            } else {
                alert('Route data not found. Please try again.');
            }
        }

        // Load real hotel and restaurant data
        async function loadTripData(cities) {
            try {
                console.log('Loading real trip data for cities:', cities);
                
                const response = await fetch('/api/trip-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cities: cities })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Received trip data:', data);
                    return data.data || {};
                } else {
                    console.error('Trip data API error:', response.status);
                    return {};
                }
            } catch (error) {
                console.error('Failed to load trip data:', error);
                return {};
            }
        }

        // Enhanced functionality for new features
        async function saveTrip(index) {
            try {
                let itineraries = getItineraries();
                const selectedRoute = itineraries[index];
                
                if (!selectedRoute) {
                    alert('Trip data not found');
                    return;
                }
                
                const tripName = prompt('Give your trip a name:', selectedRoute.name);
                if (!tripName) return;
                
                const response = await fetch('/api/save-trip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trip_name: tripName,
                        trip_data: selectedRoute,
                        is_favorite: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update button state
                    const saveBtn = document.querySelector(`[onclick="saveTrip(${index})"]`);
                    saveBtn.classList.add('saved');
                    saveBtn.innerHTML = '<i class="fas fa-check"></i>';
                    saveBtn.title = 'Trip Saved!';
                    
                    alert('Trip saved successfully!');
                } else {
                    alert(data.error || 'Failed to save trip');
                }
                
            } catch (error) {
                console.error('Save trip error:', error);
                alert('Please log in to save trips');
            }
        }
        
        async function shareTrip(index) {
            try {
                let itineraries = getItineraries();
                const selectedRoute = itineraries[index];
                
                if (!selectedRoute) {
                    alert('Trip data not found');
                    return;
                }
                
                // For now, share via URL
                const shareData = {
                    title: selectedRoute.name,
                    text: `Check out this amazing ${selectedRoute.route_type} route from ${selectedRoute.start_city.name} to ${selectedRoute.end_city.name}!`,
                    url: window.location.href
                };
                
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback: copy to clipboard
                    const shareText = `${shareData.text} ${shareData.url}`;
                    await navigator.clipboard.writeText(shareText);
                    alert('Trip details copied to clipboard!');
                }
                
            } catch (error) {
                console.error('Share trip error:', error);
                alert('Sharing not supported on this device');
            }
        }
        
        async function checkWeather(index) {
            try {
                let itineraries = getItineraries();
                const selectedRoute = itineraries[index];
                
                if (!selectedRoute) {
                    alert('Trip data not found');
                    return;
                }
                
                // Get all cities in the route
                const cities = [
                    selectedRoute.start_city,
                    ...selectedRoute.intermediate_cities,
                    selectedRoute.end_city
                ].map(city => ({
                    name: city.name,
                    coordinates: city.coordinates
                }));
                
                const response = await fetch('/api/weather/route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cities: cities })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayWeatherModal(data.weather_data, data.analysis);
                } else {
                    alert('Weather information unavailable');
                }
                
            } catch (error) {
                console.error('Weather check error:', error);
                alert('Weather service unavailable');
            }
        }
        
        function displayWeatherModal(weatherData, analysis) {
            let weatherHtml = '<div style="max-height: 400px; overflow-y: auto;">';
            
            // Overall conditions
            weatherHtml += `<h4 style="color: #6366f1; margin-bottom: 1rem;">
                <i class="fas fa-cloud-sun me-2"></i>
                Weather Conditions: ${analysis.overall_conditions.toUpperCase()}
            </h4>`;
            
            // Weather alerts
            if (analysis.alerts && analysis.alerts.length > 0) {
                weatherHtml += '<div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
                weatherHtml += '<h5 style="color: #dc2626; margin-bottom: 0.5rem;"><i class="fas fa-exclamation-triangle me-2"></i>Weather Alerts</h5>';
                analysis.alerts.forEach(alert => {
                    weatherHtml += `<p style="margin: 0.25rem 0; color: #991b1b;">• ${alert}</p>`;
                });
                weatherHtml += '</div>';
            }
            
            // Current weather for each city
            weatherHtml += '<h5 style="margin: 1.5rem 0 1rem 0;">Current Weather</h5>';
            Object.entries(weatherData).forEach(([city, weather]) => {
                const current = weather.current;
                weatherHtml += `
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <strong>${city}</strong>: ${current.temperature}°C, ${current.condition}
                        <br><small>Feels like ${current.feels_like}°C • Humidity ${current.humidity}% • Wind ${current.wind_speed} m/s</small>
                    </div>
                `;
            });
            
            // Recommendations
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                weatherHtml += '<h5 style="margin: 1.5rem 0 1rem 0;">Travel Recommendations</h5>';
                analysis.recommendations.forEach(rec => {
                    weatherHtml += `<p style="margin: 0.25rem 0;">• ${rec}</p>`;
                });
            }
            
            weatherHtml += '</div>';
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 2rem; max-width: 600px; width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1e293b;">Weather Forecast</h3>
                        <button onclick="this.closest('[style*=fixed]').remove()" 
                                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">×</button>
                    </div>
                    ${weatherHtml}
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function getItineraries() {
            // Try to get data from sessionStorage first
            try {
                const storedData = sessionStorage.getItem('travelPlanResult');
                if (storedData) {
                    const data = JSON.parse(storedData);
                    return data.data?.routes || [];
                }
            } catch (e) {
                console.error('Error loading stored data:', e);
            }
            
            // Return empty array if no real data
            return [];
        }
        
        // Add custom CSS for map icons
        const style = document.createElement('style');
        style.textContent = `
            .custom-div-icon {
                background: transparent !important;
                border: none !important;
                font-size: 16px;
                text-align: center;
                line-height: 20px;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>